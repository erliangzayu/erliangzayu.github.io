<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦ LionfishåŸ Â· OCå®æ—¶è¡Œè¸ª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: #0f1623; color: #e6edf3; padding: 20px; min-height: 100vh; overflow-x: hidden; }
        
        /* é¡¶éƒ¨æ—¶é—´+è·¯å¾„+æç¤º */
        .header { text-align: center; margin-bottom: 24px; }
        .title { font-size: 24px; font-weight: 600; color: #d7e4ff; margin-bottom: 8px; }
        .real-clock { display: inline-block; background: #1b263b; padding: 8px 16px; border-radius: 30px; color: #a9b8d4; font-size: 15px; }
        .area-path { margin-top: 8px; font-size: 14px; color: #8a9bb8; }
        .area-path.random { color: #ff6b8b; font-weight: 600; }
        .tip-bar { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ff6b8b; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 14px; z-index: 999; opacity: 0; transition: opacity 0.3s ease; }
        .tip-bar.show { opacity: 1; }
        
        /* å¤§åŒºå¯¼èˆªï¼ˆä¸å˜ï¼‰ */
        .big-area-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 8px 0; scrollbar-width: none; margin-bottom: 16px; }
        .big-area-scroll::-webkit-scrollbar { display: none; }
        .big-area-tab { white-space: nowrap; padding: 8px 16px; border: 2px solid #253450; border-radius: 20px; cursor: pointer; transition: 0.3s; color: #c2d0e7; }
        .big-area-tab.active { background: #3a6ef0; color: #fff; border-color: #3a6ef0; }
        
        /* å°åœ°ç‚¹æŠ½å±‰æ ·å¼ */
        .small-area-drawer-wrap { 
            background: #172135; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            overflow: hidden;
            width: 100%; 
            max-width: 100%; 
        }
        .small-area-drawer-header { 
            padding: 12px 16px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            cursor: pointer; 
            border-bottom: 1px solid #253450;
        }
        .small-area-drawer-title { 
            font-size: 15px; 
            color: #edf2ff; 
            font-weight: 600; 
        }
        .small-area-drawer-arrow { 
            color: #8a9bb8; 
            transition: transform 0.3s ease; 
        }
        .small-area-drawer-arrow.active { 
            transform: rotate(180deg); 
        }
        .small-area-drawer-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease;
        }
        .small-area-drawer-content.show { 
            max-height: 200px; 
            padding: 8px 0;
            overflow-y: auto; 
        }
        
        /* å°åœ°ç‚¹åˆ—è¡¨ï¼ˆæŠ½å±‰å†…ï¼‰ */
        .small-area-list { 
            padding: 0 8px; 
        }
        .small-area-item { 
            padding: 10px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.3s; 
            margin: 4px 0; 
            color: #c2d0e7;
        }
        .small-area-item.important { 
            background: #2d3b55; 
            border-left: 4px solid #ff6b8b; 
            color: #ff6b8b; 
        }
        .small-area-item.active { 
            background: #4d82f9; 
            color: #fff; 
        }
        .small-area-item.important.active { 
            background: #ff6b8b; 
            color: #fff; 
            border-left-color: #fff; 
        }
        .small-area-item:hover { 
            background: #253450; 
        }
        
        /* ä¸»ä½“å®¹å™¨ï¼šOCå¡ç‰‡ + ä¸»äººæ  */
        .main-container { display: flex; gap: 20px; margin-top: 20px; }
        .oc-container { flex: 1; }
        .owner-sidebar { width: 280px; background: #172135; border-radius: 18px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); flex-shrink: 0; display: none; }
        .owner-title { font-size: 16px; font-weight: 600; color: #edf2ff; margin-bottom: 12px; border-bottom: 1px solid #253450; padding-bottom: 8px; }
        .owner-card { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .owner-avatar { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; }
        .owner-info { flex: 1; }
        .owner-name { font-size: 15px; font-weight: 600; color: #edf2ff; }
        .owner-status { font-size: 12px; color: #9cb8e7; }
        
        /* OCå¡ç‰‡ç½‘æ ¼ */
        .oc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .oc-card { position: relative; background: #172135; border-radius: 18px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-left: 4px solid #4d82f9; cursor: pointer; transition: 0.3s; }
        .oc-card.random { border-left-color: #ff6b8b; }
        .oc-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(77,130,249,0.25); }
        .oc-random-tag { position: absolute; top: 10px; right: 10px; background: #ff6b8b; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 6px; }
        .oc-avatar { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; margin-right: 12px; }
        .oc-row { display: flex; align-items: center; }
        .oc-info { flex: 1; }
        .oc-name { font-size: 16px; font-weight: 600; color: #edf2ff; margin-bottom: 4px; }
        .oc-place { font-size: 12px; color: #9cb8e7; }
        .oc-action { font-size: 14px; color: #c2d0e7; margin-top: 6px; line-height: 1.4; }
        
        /* æ‚¬æµ®å¼¹çª— */
        .oc-popup { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); width: 200px; background: #1e2a44; color: #e6edf3; padding: 12px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); font-size: 14px; line-height: 1.5; z-index: 10; opacity: 0; pointer-events: none; transition: 0.2s; }
        .oc-card:hover .oc-popup { opacity: 1; pointer-events: all; }
        .oc-popup a { color: #5f9fff; text-decoration: underline; }
        
        /* èŠå¤©æ°”æ³¡ */
        .chat-bubble-wrap { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; flex-direction: column; gap: 8px; max-width: 80%; }
        .chat-bubble { background: #1e2a44; padding: 12px 16px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 10px; animation: fadeInUp 0.3s ease; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .chat-content { flex: 1; }
        .chat-name { font-size: 12px; color: #9cb8e7; margin-bottom: 2px; }
        .chat-text { font-size: 14px; color: #e6edf3; }
        
        /* ç©ºçŠ¶æ€ */
        .empty { grid-column: span 2; text-align: center; padding: 60px 0; color: #6b7fa5; }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .fade-out { animation: fadeOut 0.3s ease forwards; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .owner-sidebar { width: 100%; display: none; margin-top: 20px; }
            .oc-grid { grid-template-columns: 1fr; }
            .chat-bubble-wrap { bottom: 20px; max-width: 90%; }
            .small-area-drawer-content.show { max-height: 150px; }
        }
    </style>
</head>
<body>
    <!-- éšæœºäº‹ä»¶æç¤ºæ¡ -->
    <div class="tip-bar" id="tipBar"></div>

    <div class="header">
        <div class="title">ğŸ¦ LionfishåŸ Â· OCå®æ—¶è¡Œè¸ª</div>
        <div class="real-clock" id="clock">åŠ è½½ç³»ç»Ÿæ—¶é—´â€¦</div>
        <div class="area-path" id="areaPath">1åŒº > å±…é…’å±‹</div>
    </div>

    <!-- å¤§åŒºå¯¼èˆªï¼ˆä¸å˜ï¼‰ -->
    <div class="big-area-scroll" id="bigAreaWrap"></div>

    <!-- å°åœ°ç‚¹æŠ½å±‰ -->
    <div class="small-area-drawer-wrap">
        <div class="small-area-drawer-header" id="drawerHeader">
            <div class="small-area-drawer-title">å°åœ°ç‚¹åˆ—è¡¨</div>
            <div class="small-area-drawer-arrow" id="drawerArrow">â–¼</div>
        </div>
        <div class="small-area-drawer-content" id="drawerContent">
            <div class="small-area-list" id="smallAreaList"></div>
        </div>
    </div>

    <!-- ä¸»ä½“ï¼šOCå¡ç‰‡ + ä¸»äººæ  -->
    <div class="main-container">
        <div class="oc-container" id="ocContainer">
            <div class="empty">åŠ è½½ä¸­...</div>
        </div>
        <div class="owner-sidebar" id="ownerSidebar">
            <div class="owner-title">ğŸ“ åœ°ç‚¹ä¸»äºº</div>
            <div id="ownerContent"></div>
        </div>
    </div>

    <!-- èŠå¤©æ°”æ³¡å®¹å™¨ -->
    <div class="chat-bubble-wrap" id="chatBubbleWrap"></div>

    <script>
        // å…¨å±€å˜é‡
        let ocData = [];
        let areaData = [];
        let chatData = [];
        let randomData = [];
        let currentBigArea = "";
        let currentSmallArea = "";
        let chatTriggered = new Set(); 
        let ocActionCache = {}; // æ ¸å¿ƒï¼šç¼“å­˜æ¯ä¸ªOCåœ¨å¯¹åº”åœ°ç‚¹çš„éšæœºactionï¼ŒåŒæ¬¡æµè§ˆä¸å˜åŒ–
        
        // 1. åŠ è½½æ‰€æœ‰JSONæ•°æ®åº“
        async function loadAllData() {
            try {
                const [ocRes, areaRes, chatRes, randomRes] = await Promise.all([
                    fetch('./ocData.json'),
                    fetch('./areaData.json'),
                    fetch('./chatData.json'),
                    fetch('./randomData.json')
                ]);
                
                ocData = await ocRes.json();
                areaData = await areaRes.json();
                randomData = await randomRes.json();
                chatData = await chatRes.json();
                
                // åˆå§‹åŒ–é¡µé¢
                initAreaNav();
                updateRealTime(); // ä»…æ›´æ–°æ—¶é—´æ˜¾ç¤º
                renderOC(); // é¦–æ¬¡æ¸²æŸ“OCï¼Œç”Ÿæˆå¹¶ç¼“å­˜action
                // ä»…æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼Œä¸å†æ¯ç§’é‡æ–°æ¸²æŸ“OC
                setInterval(updateRealTimeOnly, 1000);
            } catch (err) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥ï¼š", err);
                document.getElementById("ocContainer").innerHTML = `<div class="empty">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥JSONæ–‡ä»¶</div>`;
            }
        }

        // 2. åˆå§‹åŒ–å¤§åŒº/å°åœ°ç‚¹å¯¼èˆª
        function initAreaNav() {
            const bigAreaWrap = document.getElementById("bigAreaWrap");
            const drawerHeader = document.getElementById("drawerHeader");
            const drawerArrow = document.getElementById("drawerArrow");
            const drawerContent = document.getElementById("drawerContent");
            
            // æ¸²æŸ“å¤§åŒº
            const bigAreas = [...new Set(areaData.map(item => item.bigArea))];
            bigAreaWrap.innerHTML = bigAreas.map(area => `
                <div class="big-area-tab" data-area="${area}">${area}</div>
            `).join('');
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¤§åŒº
            currentBigArea = bigAreas[0];
            document.querySelector(`.big-area-tab[data-area="${currentBigArea}"]`).classList.add("active");
            
            // æ¸²æŸ“å½“å‰å¤§åŒºçš„å°åœ°ç‚¹ï¼ˆæŠ½å±‰å†…ï¼‰
            renderSmallArea(currentBigArea);
            
            // å¤§åŒºåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll(".big-area-tab").forEach(tab => {
                tab.addEventListener("click", () => {
                    document.querySelectorAll(".big-area-tab").forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    currentBigArea = tab.dataset.area;
                    renderSmallArea(currentBigArea);
                    // åˆ‡æ¢å¤§åŒºåé‡æ–°æ¸²æŸ“OCï¼ˆå¤ç”¨ç¼“å­˜çš„actionï¼‰
                    renderOC();
                    renderOwnerSidebar();
                });
            });
            
            // æŠ½å±‰å±•å¼€/æ”¶èµ·äº‹ä»¶
            drawerHeader.addEventListener("click", () => {
                drawerContent.classList.toggle("show");
                drawerArrow.classList.toggle("active");
                drawerArrow.innerText = drawerContent.classList.contains("show") ? "â–²" : "â–¼";
            });
            
            // å°åœ°ç‚¹ç‚¹å‡»äº‹ä»¶
            document.getElementById("smallAreaList").addEventListener("click", (e) => {
                const item = e.target.closest(".small-area-item");
                if (!item) return;
                document.querySelectorAll(".small-area-item").forEach(t => t.classList.remove("active"));
                item.classList.add("active");
                currentSmallArea = item.dataset.area;
                updateAreaPath();
                // åˆ‡æ¢å°åœ°ç‚¹åé‡æ–°æ¸²æŸ“OCï¼ˆå¤ç”¨ç¼“å­˜çš„actionï¼‰
                renderOC();
                renderOwnerSidebar();
            });
        }

        // 3. æ¸²æŸ“å°åœ°ç‚¹ï¼ˆæŠ½å±‰å†…+é‡è¦åœ°ç‚¹ç½®é¡¶ï¼‰
        function renderSmallArea(bigArea) {
            const smallAreaList = document.getElementById("smallAreaList");
            const smallAreas = areaData.filter(item => item.bigArea === bigArea);
            
            // åˆ†ç¦»é‡è¦åœ°ç‚¹å’Œæ™®é€šåœ°ç‚¹ï¼Œé‡è¦åœ°ç‚¹ç½®é¡¶
            const importantAreas = smallAreas.filter(item => item.important);
            const normalAreas = smallAreas.filter(item => !item.important);
            const sortedAreas = [...importantAreas, ...normalAreas];
            
            smallAreaList.innerHTML = sortedAreas.map(item => {
                // åˆ¤æ–­æ˜¯å¦æ˜¯é‡è¦åœ°ç‚¹
                const isImportant = item.important ? "important" : "";
                return `
                    <div class="small-area-item ${isImportant}" data-area="${item.smallArea}">
                        ${item.smallArea}
                    </div>
                `;
            }).join('');
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå°åœ°ç‚¹
            currentSmallArea = sortedAreas[0].smallArea;
            document.querySelector(`.small-area-item[data-area="${currentSmallArea}"]`).classList.add("active");
            updateAreaPath();
            renderOwnerSidebar();
            
            // é»˜è®¤å±•å¼€æŠ½å±‰
            document.getElementById("drawerContent").classList.add("show");
            document.getElementById("drawerArrow").classList.add("active");
            document.getElementById("drawerArrow").innerText = "â–²";
        }

        // 4. æ›´æ–°å½“å‰è·¯å¾„ï¼ˆå¦‚ï¼š1åŒº > å±…é…’å±‹ï¼‰
        function updateAreaPath() {
            const pathEl = document.getElementById("areaPath");
            pathEl.innerText = `${currentBigArea} > ${currentSmallArea}`;
            pathEl.classList.remove("random");
        }

        // 5. è·å–å®æ—¶ç³»ç»Ÿæ—¶é—´ï¼ˆç²¾å‡†åˆ°åˆ†é’Ÿï¼‰
        function getRealTime() {
            const d = new Date();
            return {
                week: d.getDay(),       // 0=å‘¨æ—¥,1=å‘¨ä¸€...6=å‘¨å…­
                hour: d.getHours(),     // 0-23
                minute: d.getMinutes(), // 0-59
                timeStr: `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`, // 08:01æ ¼å¼
                str: `${["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][d.getDay()]} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`
            };
        }

        // 6. æ˜¾ç¤ºéšæœºäº‹ä»¶æç¤º
        function showRandomTip(text) {
            const tipBar = document.getElementById("tipBar");
            tipBar.innerText = text;
            tipBar.classList.add("show");
            setTimeout(() => {
                tipBar.classList.remove("show");
            }, 3000);
        }

        // 7. è§£ææ—¶é—´æ®µï¼ˆä¿®å¤è·¨å¤©bugï¼‰
        function isInTimeRange(currentTimeStr, timeRange) {
            const [start, end] = timeRange.split("-");
            const current = new Date(`2000-01-01 ${currentTimeStr}`);
            const startDate = new Date(`2000-01-01 ${start}`);
            const endDate = new Date(`2000-01-01 ${end}`);
            
            // å¤„ç†è·¨å¤©æƒ…å†µï¼ˆæ¯”å¦‚19:30-04:00ï¼‰
            if (endDate < startDate) {
                // è·¨å¤©ï¼šå½“å‰æ—¶é—´ >= start æˆ– å½“å‰æ—¶é—´ < end
                return current >= startDate || current < endDate;
            } else {
                // éè·¨å¤©ï¼šå½“å‰æ—¶é—´ >= start ä¸” < end
                return current >= startDate && current < endDate;
            }
        }

        // 8. è¯»å–åœ°ç‚¹ä¸“å±éšæœºactionï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šç¼“å­˜æœºåˆ¶ï¼‰
        function getLocationRandomAction(ocName, area) {
            // ç”Ÿæˆç¼“å­˜keyï¼šOCåç§°+åœ°ç‚¹ï¼Œç¡®ä¿å”¯ä¸€
            const cacheKey = `${ocName}_${area}`;
            // å¦‚æœç¼“å­˜ä¸­å·²æœ‰ï¼Œç›´æ¥è¿”å›ï¼›æ²¡æœ‰åˆ™ç”Ÿæˆå¹¶ç¼“å­˜
            if (ocActionCache[cacheKey]) {
                return ocActionCache[cacheKey];
            }
            
            // æŸ¥æ‰¾OCæ•°æ®
            const oc = ocData.find(item => item.name === ocName);
            if (!oc) return "æš‚æ— çŠ¶æ€";
            
            const actions = oc.locationRandomActions[area] || [];
            const randomAction = actions.length > 0 ? getRandomText(actions) : "æš‚æ— çŠ¶æ€";
            // ç¼“å­˜è¯¥actionï¼ŒåŒæ¬¡æµè§ˆä¸å†å˜åŒ–
            ocActionCache[cacheKey] = randomAction;
            return randomAction;
        }

        // 9. æ£€æŸ¥éšæœºäº‹ä»¶ï¼ˆæ ¸å¿ƒï¼šæ¦‚ç‡è®¡ç®—ï¼‰
        function checkRandomEvent(oc, now) {
            if (!oc.randomEvents || oc.randomEvents.length === 0) {
                // æ— éšæœºäº‹ä»¶ï¼Œè¿”å›åŸºç¡€è¡Œç¨‹
                const baseSchedule = oc.baseSchedule.find(s => 
                    s.week.includes(now.week) && isInTimeRange(now.timeStr, s.timeRange)
                );
                return {
                    isRandom: false,
                    schedule: baseSchedule || null
                };
            }
            
            // æŸ¥æ‰¾å½“å‰æ—¶é—´çš„éšæœºäº‹ä»¶
            const randomEvent = oc.randomEvents.find(e => 
                e.week.includes(now.week) && isInTimeRange(now.timeStr, e.timeRange)
            );
            
            if (!randomEvent) {
                // æ— å¯¹åº”éšæœºäº‹ä»¶ï¼Œè¿”å›åŸºç¡€è¡Œç¨‹
                const baseSchedule = oc.baseSchedule.find(s => 
                    s.week.includes(now.week) && isInTimeRange(now.timeStr, s.timeRange)
                );
                return {
                    isRandom: false,
                    schedule: baseSchedule || null
                };
            }
            
            // è®¡ç®—æ¦‚ç‡ï¼ˆ0-100éšæœºæ•°ï¼‰
            const randomNum = Math.floor(Math.random() * 101);
            if (randomNum <= randomEvent.probability) {
                // è§¦å‘éšæœºäº‹ä»¶
                showRandomTip(randomEvent.tip);
                return {
                    isRandom: true,
                    schedule: randomEvent
                };
            } else {
                // æœªè§¦å‘ï¼Œè¿”å›åŸºç¡€è¡Œç¨‹
                const baseSchedule = oc.baseSchedule.find(s => 
                    s.week.includes(now.week) && isInTimeRange(now.timeStr, s.timeRange)
                );
                return {
                    isRandom: false,
                    schedule: baseSchedule || null
                };
            }
        }

        // 10. ä»…æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼Œä¸é‡æ–°æ¸²æŸ“OCï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
        function updateRealTimeOnly() {
            const now = getRealTime();
            document.getElementById("clock").innerText = "å½“å‰ Â· " + now.str;
            // ç§»é™¤æ¯ç§’é‡æ–°æ¸²æŸ“OCçš„é€»è¾‘
        }

        // 11. é¦–æ¬¡åŠ è½½æ—¶æ›´æ–°æ—¶é—´+æ¸²æŸ“OC
        function updateRealTime() {
            const now = getRealTime();
            document.getElementById("clock").innerText = "å½“å‰ Â· " + now.str;
        }

        // 12. è·å–éšæœºæ–‡æ¡ˆ
        function getRandomText(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // 13. æ¸²æŸ“OCå¡ç‰‡
        function renderOC() {
            const now = getRealTime();
            const ocContainer = document.getElementById("ocContainer");
            const pathEl = document.getElementById("areaPath");
            
            // æ¸…ç©ºéšæœºè·¯å¾„æ ·å¼
            pathEl.classList.remove("random");
            
            // ç­›é€‰å½“å‰æ—¶é—´åœ¨å½“å‰å°åœ°ç‚¹çš„OC
            const filteredOC = [];
            ocData.forEach(oc => {
                const { isRandom, schedule } = checkRandomEvent(oc, now);
                if (schedule && schedule.area === currentSmallArea) {
                    filteredOC.push({
                        oc: oc,
                        schedule: schedule,
                        isRandom: isRandom
                    });
                }
            });
            
            // æ¸²æŸ“OCå¡ç‰‡
            if (filteredOC.length === 0) {
                ocContainer.innerHTML = `<div class="empty">æ­¤åˆ»è¿™é‡Œæ²¡æœ‰OC</div>`;
            } else {
                ocContainer.innerHTML = `<div class="oc-grid">` + filteredOC.map(item => {
                    const oc = item.oc;
                    const schedule = item.schedule;
                    const isRandom = item.isRandom;
                    
                    // è°ƒç”¨å¸¦ç¼“å­˜çš„éšæœºactionå‡½æ•°
                    const randomAction = getLocationRandomAction(oc.name, schedule.area);
                    
                    // éšæœºäº‹ä»¶æ ‡ç­¾
                    const randomTag = isRandom ? `<div class="oc-random-tag">âœ¨ éšæœºäº‹ä»¶</div>` : "";
                    
                    // è·¯å¾„æ åŠ éšæœºæ ·å¼
                    if (isRandom) pathEl.classList.add("random");
                    
                    return `
                        <div class="oc-card ${isRandom ? 'random' : ''}">
                            ${randomTag}
                            <div class="oc-row">
                                <img src="${oc.avatar}" class="oc-avatar" alt="${oc.name}">
                                <div class="oc-info">
                                    <div class="oc-name">${oc.name}</div>
                                    <div class="oc-place">ğŸ“ ${schedule.area}</div>
                                </div>
                            </div>
                            <div class="oc-action">${randomAction}</div>
                            <div class="oc-popup">
                                <div>ğŸ“… å½“å‰æ—¶æ®µï¼š${schedule.timeRange || schedule.time}</div>
                                <div>â³ å®æ—¶çŠ¶æ€</div>
                                <div><a href="${oc.link}" target="_blank">ğŸ”— æŸ¥çœ‹ä¸ªäººä¸»é¡µ</a></div>
                            </div>
                        </div>
                    `;
                }).join('') + `</div>`;
            }
            
            // æ£€æŸ¥æ˜¯å¦è§¦å‘å¯¹è¯
            const ocNames = filteredOC.map(item => item.oc.name);
            checkChatTrigger(ocNames, now);
        }

        // 14. æ¸²æŸ“åœ°ç‚¹ä¸»äººæ 
        function renderOwnerSidebar() {
            const ownerSidebar = document.getElementById("ownerSidebar");
            const ownerContent = document.getElementById("ownerContent");
            const now = getRealTime();
            
            // è·å–å½“å‰å°åœ°ç‚¹çš„ä¸»äººä¿¡æ¯
            const areaInfo = areaData.find(item => item.smallArea === currentSmallArea);
            if (!areaInfo || !areaInfo.owner || areaInfo.owner.length === 0) {
                ownerSidebar.style.display = "none";
                return;
            }
            
            ownerSidebar.style.display = "block";
            let ownerHtml = "";
            
            areaInfo.owner.forEach(ownerName => {
                // æŸ¥æ‰¾ä¸»äººçš„OCä¿¡æ¯
                const ownerOC = ocData.find(oc => oc.name === ownerName);
                if (!ownerOC) return;
                
                // æ£€æŸ¥ä¸»äººå½“å‰çŠ¶æ€ï¼ˆå«éšæœºäº‹ä»¶ï¼‰
                const { isRandom, schedule } = checkRandomEvent(ownerOC, now);
                let status = "æš‚æ— çŠ¶æ€";
                
                if (schedule) {
                    // è°ƒç”¨å¸¦ç¼“å­˜çš„éšæœºactionå‡½æ•°
                    const randomAction = getLocationRandomAction(ownerOC.name, schedule.area);
                    status = isRandom ? 
                        `âœ… éšæœºäº‹ä»¶ï¼š${randomAction}` : 
                        `âœ… æ­£åœ¨æ­¤å¤„ï¼š${randomAction}`;
                } else {
                    // ä¸»äººä¸åœ¨ï¼šéšæœºä¸åœ¨åœºæ–‡æ¡ˆï¼ˆä»…é¦–æ¬¡ç”Ÿæˆï¼Œç¼“å­˜ï¼‰
                    const cacheKey = `${ownerName}_absent`;
                    if (!ocActionCache[cacheKey]) {
                        const charAbsentText = randomData.absentText[ownerName] || randomData.absentText.default;
                        ocActionCache[cacheKey] = getRandomText(charAbsentText);
                    }
                    status = `ğŸ”´ æš‚æ—¶ç¦»å¼€ï¼š${ocActionCache[cacheKey]}`;
                }
                
                ownerHtml += `
                    <div class="owner-card">
                        <img src="${ownerOC.avatar}" class="owner-avatar" alt="${ownerName}">
                        <div class="owner-info">
                            <div class="owner-name">${ownerName}</div>
                            <div class="owner-status">${status}</div>
                        </div>
                    </div>
                `;
            });
            
            ownerContent.innerHTML = ownerHtml || `<div class="empty">æš‚æ— ä¸»äººä¿¡æ¯</div>`;
        }

        // 15. æ£€æŸ¥æ˜¯å¦è§¦å‘æŒ‡å®šå¯¹è¯
        function checkChatTrigger(ocNames, now) {
            const chatWrap = document.getElementById("chatBubbleWrap");
            // è·å–å½“å‰åœ°ç‚¹çš„å¯¹è¯
            const areaChats = chatData.filter(chat => chat.area === currentSmallArea);
            
            areaChats.forEach(chat => {
                // æ£€æŸ¥å¯¹è¯IDæ˜¯å¦å·²è§¦å‘
                if (chatTriggered.has(chat.id)) return;
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å‚ä¸äººéƒ½åœ¨åœº
                const allPresent = chat.characters.every(char => 
                    ocNames.includes(char)
                );
                
                if (allPresent) {
                    // æ ‡è®°ä¸ºå·²è§¦å‘
                    chatTriggered.add(chat.id);
                    // éšæœºé€‰ä¸€æ®µå¯¹è¯
                    const randomChat = getRandomText(chat.dialogues);
                    // æ¸²æŸ“èŠå¤©æ°”æ³¡
                    renderChatBubble(randomChat, chat.characters);
                }
            });
        }

        // 16. æ¸²æŸ“èŠå¤©æ°”æ³¡
        function renderChatBubble(dialogue, characters) {
            const chatWrap = document.getElementById("chatBubbleWrap");
            chatWrap.innerHTML = "";
            
            // æŒ‰é¡ºåºæ¸²æŸ“å¯¹è¯
            dialogue.forEach((msg, index) => {
                const charOC = ocData.find(oc => oc.name === msg.character);
                if (!charOC) return;
                
                const bubble = document.createElement("div");
                bubble.className = "chat-bubble";
                bubble.style.animationDelay = `${index * 0.3}s`;
                bubble.innerHTML = `
                    <img src="${charOC.avatar}" class="chat-avatar" alt="${msg.character}">
                    <div class="chat-content">
                        <div class="chat-name">${msg.character}</div>
                        <div class="chat-text">${msg.text}</div>
                    </div>
                `;
                chatWrap.appendChild(bubble);
                
                // æ‰€æœ‰æ°”æ³¡æ˜¾ç¤ºå®Œåï¼Œ5ç§’åå¼€å§‹æ¶ˆå¤±
                if (index === dialogue.length - 1) {
                    setTimeout(() => {
                        document.querySelectorAll(".chat-bubble").forEach((b, i) => {
                            setTimeout(() => {
                                b.classList.add("fade-out");
                                if (i === dialogue.length - 1) {
                                    setTimeout(() => chatWrap.innerHTML = "", 300);
                                }
                            }, i * 200);
                        });
                    }, 5000);
                }
            });
        }

        // åˆå§‹åŒ–
        loadAllData();
    </script>
</body>
</html>
