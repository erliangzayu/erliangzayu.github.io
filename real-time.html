<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦ LionfishåŸ Â· OCå®æ—¶è¡Œè¸ª</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: #0f1623; color: #e6edf3; padding: 20px; min-height: 100vh; overflow-x: hidden; }
        
        /* é¡¶éƒ¨æ—¶é—´+è·¯å¾„ */
        .header { text-align: center; margin-bottom: 24px; }
        .title { font-size: 24px; font-weight: 600; color: #d7e4ff; margin-bottom: 8px; }
        .real-clock { display: inline-block; background: #1b263b; padding: 8px 16px; border-radius: 30px; color: #a9b8d4; font-size: 15px; }
        .area-path { margin-top: 8px; font-size: 14px; color: #8a9bb8; }
        
        /* å¤§åŒºå¯¼èˆª */
        .big-area-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 8px 0; scrollbar-width: none; margin-bottom: 12px; }
        .big-area-scroll::-webkit-scrollbar { display: none; }
        .big-area-tab { white-space: nowrap; padding: 8px 16px; border: 2px solid #253450; border-radius: 20px; cursor: pointer; transition: 0.3s; color: #c2d0e7; }
        .big-area-tab.active { background: #3a6ef0; color: #fff; border-color: #3a6ef0; }
        
        /* å°åœ°ç‚¹å¯¼èˆª+æ‹–æ‹½å®¹å™¨ */
        .small-area-wrap { position: relative; overflow: hidden; }
        .small-area-scroll { display: flex; gap: 12px; padding: 10px 0; transition: transform 0.3s ease; }
        .small-area-tab { white-space: nowrap; padding: 10px 20px; border: 2px solid #253450; border-radius: 30px; cursor: pointer; transition: 0.3s; color: #c2d0e7; flex-shrink: 0; }
        .small-area-tab.active { background: #4d82f9; color: #fff; border-color: #4d82f9; }
        
        /* ä¸»ä½“å®¹å™¨ï¼šOCå¡ç‰‡ + ä¸»äººæ  */
        .main-container { display: flex; gap: 20px; margin-top: 20px; }
        .oc-container { flex: 1; }
        .owner-sidebar { width: 280px; background: #172135; border-radius: 18px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); flex-shrink: 0; display: none; }
        .owner-title { font-size: 16px; font-weight: 600; color: #edf2ff; margin-bottom: 12px; border-bottom: 1px solid #253450; padding-bottom: 8px; }
        .owner-card { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .owner-avatar { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; }
        .owner-info { flex: 1; }
        .owner-name { font-size: 15px; font-weight: 600; color: #edf2ff; }
        .owner-status { font-size: 12px; color: #9cb8e7; }
        
        /* OCå¡ç‰‡ç½‘æ ¼ */
        .oc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .oc-card { position: relative; background: #172135; border-radius: 18px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-left: 4px solid #4d82f9; cursor: pointer; transition: 0.3s; }
        .oc-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(77,130,249,0.25); }
        .oc-avatar { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; margin-right: 12px; }
        .oc-row { display: flex; align-items: center; }
        .oc-info { flex: 1; }
        .oc-name { font-size: 16px; font-weight: 600; color: #edf2ff; margin-bottom: 4px; }
        .oc-place { font-size: 12px; color: #9cb8e7; }
        .oc-action { font-size: 14px; color: #c2d0e7; margin-top: 6px; line-height: 1.4; }
        
        /* æ‚¬æµ®å¼¹çª— */
        .oc-popup { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); width: 200px; background: #1e2a44; color: #e6edf3; padding: 12px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); font-size: 14px; line-height: 1.5; z-index: 10; opacity: 0; pointer-events: none; transition: 0.2s; }
        .oc-card:hover .oc-popup { opacity: 1; pointer-events: all; }
        .oc-popup a { color: #5f9fff; text-decoration: underline; }
        
        /* èŠå¤©æ°”æ³¡ */
        .chat-bubble-wrap { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; flex-direction: column; gap: 8px; max-width: 80%; }
        .chat-bubble { background: #1e2a44; padding: 12px 16px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; gap: 10px; animation: fadeInUp 0.3s ease; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .chat-content { flex: 1; }
        .chat-name { font-size: 12px; color: #9cb8e7; margin-bottom: 2px; }
        .chat-text { font-size: 14px; color: #e6edf3; }
        
        /* ç©ºçŠ¶æ€ */
        .empty { grid-column: span 2; text-align: center; padding: 60px 0; color: #6b7fa5; }
        
        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .fade-out { animation: fadeOut 0.3s ease forwards; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .owner-sidebar { width: 100%; display: none; margin-top: 20px; }
            .oc-grid { grid-template-columns: 1fr; }
            .chat-bubble-wrap { bottom: 20px; max-width: 90%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ¦ LionfishåŸ Â· OCå®æ—¶è¡Œè¸ª</div>
        <div class="real-clock" id="clock">åŠ è½½ç³»ç»Ÿæ—¶é—´â€¦</div>
        <div class="area-path" id="areaPath">1åŒº > å±…é…’å±‹</div>
    </div>

    <!-- å¤§åŒºå¯¼èˆª -->
    <div class="big-area-scroll" id="bigAreaWrap"></div>

    <!-- å°åœ°ç‚¹å¯¼èˆªï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰ -->
    <div class="small-area-wrap" id="smallAreaWrap">
        <div class="small-area-scroll" id="smallAreaScroll"></div>
    </div>

    <!-- ä¸»ä½“ï¼šOCå¡ç‰‡ + ä¸»äººæ  -->
    <div class="main-container">
        <div class="oc-container" id="ocContainer">
            <div class="empty">åŠ è½½ä¸­...</div>
        </div>
        <div class="owner-sidebar" id="ownerSidebar">
            <div class="owner-title">ğŸ“ åœ°ç‚¹ä¸»äºº</div>
            <div id="ownerContent"></div>
        </div>
    </div>

    <!-- èŠå¤©æ°”æ³¡å®¹å™¨ -->
    <div class="chat-bubble-wrap" id="chatBubbleWrap"></div>

    <script>
        // å…¨å±€å˜é‡
        let ocData = [];
        let areaData = [];
        let chatData = [];
        let randomData = [];
        let currentBigArea = "";
        let currentSmallArea = "";
        let chatTriggered = new Set(); // è®°å½•å·²è§¦å‘çš„å¯¹è¯ï¼Œé˜²æ­¢é‡å¤
        
        // 1. åŠ è½½æ‰€æœ‰JSONæ•°æ®åº“
        async function loadAllData() {
            try {
                // åŠ è½½JSONæ–‡ä»¶ï¼ˆGitHub Pagesè·¯å¾„ï¼Œå’Œreal-time.htmlåŒç›®å½•ï¼‰
                const [ocRes, areaRes, chatRes, randomRes] = await Promise.all([
                    fetch('./ocData.json'),
                    fetch('./areaData.json'),
                    fetch('./chatData.json'),
                    fetch('./randomData.json')
                ]);
                
                ocData = await ocRes.json();
                areaData = await areaRes.json();
                randomData = await randomRes.json();
                chatData = await chatRes.json();
                
                // åˆå§‹åŒ–é¡µé¢
                initAreaNav();
                initDragScroll();
                updateRealTime();
                renderOC();
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
                setInterval(updateRealTime, 60000);
            } catch (err) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥ï¼š", err);
                document.getElementById("ocContainer").innerHTML = `<div class="empty">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥JSONæ–‡ä»¶</div>`;
            }
        }

        // 2. åˆå§‹åŒ–å¤§åŒº/å°åœ°ç‚¹å¯¼èˆª
        function initAreaNav() {
            const bigAreaWrap = document.getElementById("bigAreaWrap");
            const smallAreaScroll = document.getElementById("smallAreaScroll");
            
            // æ¸²æŸ“å¤§åŒº
            const bigAreas = [...new Set(areaData.map(item => item.bigArea))];
            bigAreaWrap.innerHTML = bigAreas.map(area => `
                <div class="big-area-tab" data-area="${area}">${area}</div>
            `).join('');
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¤§åŒº
            currentBigArea = bigAreas[0];
            document.querySelector(`.big-area-tab[data-area="${currentBigArea}"]`).classList.add("active");
            
            // æ¸²æŸ“å½“å‰å¤§åŒºçš„å°åœ°ç‚¹
            renderSmallArea(currentBigArea);
            
            // å¤§åŒºåˆ‡æ¢äº‹ä»¶
            document.querySelectorAll(".big-area-tab").forEach(tab => {
                tab.addEventListener("click", () => {
                    document.querySelectorAll(".big-area-tab").forEach(t => t.classList.remove("active"));
                    tab.classList.add("active");
                    currentBigArea = tab.dataset.area;
                    renderSmallArea(currentBigArea);
                });
            });
            
            // å°åœ°ç‚¹åˆ‡æ¢äº‹ä»¶
            smallAreaScroll.addEventListener("click", (e) => {
                const tab = e.target.closest(".small-area-tab");
                if (!tab) return;
                document.querySelectorAll(".small-area-tab").forEach(t => t.classList.remove("active"));
                tab.classList.add("active");
                currentSmallArea = tab.dataset.area;
                updateAreaPath();
                renderOC();
                renderOwnerSidebar();
            });
        }

        // 3. æ¸²æŸ“å°åœ°ç‚¹
        function renderSmallArea(bigArea) {
            const smallAreaScroll = document.getElementById("smallAreaScroll");
            const smallAreas = areaData.filter(item => item.bigArea === bigArea).map(item => item.smallArea);
            
            smallAreaScroll.innerHTML = smallAreas.map(area => `
                <div class="small-area-tab" data-area="${area}">${area}</div>
            `).join('');
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå°åœ°ç‚¹
            currentSmallArea = smallAreas[0];
            document.querySelector(`.small-area-tab[data-area="${currentSmallArea}"]`).classList.add("active");
            updateAreaPath();
            renderOwnerSidebar();
        }

        // 4. æ›´æ–°å½“å‰è·¯å¾„ï¼ˆå¦‚ï¼š1åŒº > å±…é…’å±‹ï¼‰
        function updateAreaPath() {
            document.getElementById("areaPath").innerText = `${currentBigArea} > ${currentSmallArea}`;
        }

        // 5. åˆå§‹åŒ–æ‹–æ‹½æ»‘åŠ¨ï¼ˆå°åœ°ç‚¹ï¼‰
        function initDragScroll() {
            const wrap = document.getElementById("smallAreaWrap");
            const scroll = document.getElementById("smallAreaScroll");
            let startX = 0;
            let scrollLeft = 0;
            let isDragging = false;
            
            // PCç«¯æ‹–æ‹½
            wrap.addEventListener("mousedown", (e) => {
                isDragging = true;
                startX = e.pageX - wrap.offsetLeft;
                scrollLeft = scroll.scrollLeft;
                wrap.style.cursor = "grabbing";
            });
            
            wrap.addEventListener("mouseleave", () => {
                isDragging = false;
                wrap.style.cursor = "grab";
            });
            
            wrap.addEventListener("mouseup", () => {
                isDragging = false;
                wrap.style.cursor = "grab";
            });
            
            wrap.addEventListener("mousemove", (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - wrap.offsetLeft;
                const walk = (x - startX) * 2;
                scroll.scrollLeft = scrollLeft - walk;
            });
            
            // ç§»åŠ¨ç«¯è§¦æ‘¸æ»‘åŠ¨
            wrap.addEventListener("touchstart", (e) => {
                isDragging = true;
                startX = e.touches[0].pageX - wrap.offsetLeft;
                scrollLeft = scroll.scrollLeft;
            });
            
            wrap.addEventListener("touchend", () => {
                isDragging = false;
            });
            
            wrap.addEventListener("touchmove", (e) => {
                if (!isDragging) return;
                const x = e.touches[0].pageX - wrap.offsetLeft;
                const walk = (x - startX) * 2;
                scroll.scrollLeft = scrollLeft - walk;
            });
        }

        // 6. è·å–å®æ—¶ç³»ç»Ÿæ—¶é—´
        function getRealTime() {
            const d = new Date();
            return {
                week: d.getDay(),       // 0=å‘¨æ—¥,1=å‘¨ä¸€...6=å‘¨å…­
                hour: d.getHours(),     // 0-23
                minute: d.getMinutes(), // 0-59
                str: `${["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][d.getDay()]} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`
            };
        }

        // 7. æ›´æ–°å®æ—¶æ—¶é—´æ˜¾ç¤º
        function updateRealTime() {
            const now = getRealTime();
            document.getElementById("clock").innerText = "å½“å‰ Â· " + now.str;
            // é‡æ–°æ¸²æŸ“OCï¼ˆæ—¶é—´å˜åŒ–å¯èƒ½å¯¼è‡´OCçŠ¶æ€å˜åŒ–ï¼‰
            renderOC();
        }

        // 8. è·å–éšæœºæ–‡æ¡ˆ
        function getRandomText(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // 9. æ¸²æŸ“OCå¡ç‰‡
        function renderOC() {
            const now = getRealTime();
            const ocContainer = document.getElementById("ocContainer");
            
            // ç­›é€‰å½“å‰æ—¶é—´ã€å½“å‰å°åœ°ç‚¹çš„OC
            const filteredOC = ocData.filter(oc => 
                oc.week.includes(now.week) && 
                oc.hour[0] <= now.hour && 
                oc.hour[1] > now.hour && 
                oc.area === currentSmallArea
            );
            
            // æ¸²æŸ“OCå¡ç‰‡
            if (filteredOC.length === 0) {
                ocContainer.innerHTML = `<div class="empty">æ­¤åˆ»è¿™é‡Œæ²¡æœ‰OC</div>`;
            } else {
                ocContainer.innerHTML = filteredOC.map(oc => {
                    // è·å–éšæœºåŠ¨ä½œæ–‡æ¡ˆ
                    const randomAction = oc.randomActions ? getRandomText(oc.randomActions) : oc.action;
                    // è®¡ç®—å‰©ä½™æ—¶é•¿
                    const remainHour = oc.hour[1] - now.hour;
                    const remainStr = remainHour > 0 ? `${remainHour}å°æ—¶` : "å³å°†ç¦»å¼€";
                    
                    return `
                        <div class="oc-card">
                            <div class="oc-row">
                                <img src="${oc.avatar}" class="oc-avatar" alt="${oc.name}">
                                <div class="oc-info">
                                    <div class="oc-name">${oc.name}</div>
                                    <div class="oc-place">ğŸ“ ${oc.area}</div>
                                </div>
                            </div>
                            <div class="oc-action">${randomAction}</div>
                            <div class="oc-popup">
                                <div>ğŸ“… åœç•™è‡³ ${oc.hour[1]}:00</div>
                                <div>â³ è¿˜å‰© ${remainStr}</div>
                                <div><a href="${oc.link}" target="_blank">ğŸ”— æŸ¥çœ‹ä¸ªäººä¸»é¡µ</a></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // æ£€æŸ¥æ˜¯å¦è§¦å‘å¯¹è¯
            checkChatTrigger(filteredOC, now);
        }

        // 10. æ¸²æŸ“åœ°ç‚¹ä¸»äººæ 
        function renderOwnerSidebar() {
            const ownerSidebar = document.getElementById("ownerSidebar");
            const ownerContent = document.getElementById("ownerContent");
            const now = getRealTime();
            
            // è·å–å½“å‰å°åœ°ç‚¹çš„ä¸»äººä¿¡æ¯
            const areaInfo = areaData.find(item => item.smallArea === currentSmallArea);
            if (!areaInfo || !areaInfo.owner || areaInfo.owner.length === 0) {
                ownerSidebar.style.display = "none";
                return;
            }
            
            ownerSidebar.style.display = "block";
            let ownerHtml = "";
            
            areaInfo.owner.forEach(ownerName => {
                // æŸ¥æ‰¾ä¸»äººçš„OCä¿¡æ¯
                const ownerOC = ocData.find(oc => oc.name === ownerName);
                if (!ownerOC) return;
                
                // åˆ¤æ–­ä¸»äººæ˜¯å¦åœ¨åœº
                const isPresent = ownerOC.week.includes(now.week) && 
                                  ownerOC.hour[0] <= now.hour && 
                                  ownerOC.hour[1] > now.hour && 
                                  ownerOC.area === currentSmallArea;
                
                let status = "";
                if (isPresent) {
                    // ä¸»äººåœ¨åœºï¼šéšæœºåŠ¨ä½œ
                    status = ownerOC.randomActions ? getRandomText(ownerOC.randomActions) : ownerOC.action;
                } else {
                    // ä¸»äººä¸åœ¨ï¼šéšæœºä¸åœ¨åœºæ–‡æ¡ˆ
                    status = getRandomText(randomData.absentText);
                }
                
                ownerHtml += `
                    <div class="owner-card">
                        <img src="${ownerOC.avatar}" class="owner-avatar" alt="${ownerName}">
                        <div class="owner-info">
                            <div class="owner-name">${ownerName}</div>
                            <div class="owner-status">${isPresent ? "âœ… æ­£åœ¨æ­¤å¤„" : "ğŸ”´ æš‚æ—¶ç¦»å¼€"}ï¼š${status}</div>
                        </div>
                    </div>
                `;
            });
            
            ownerContent.innerHTML = ownerHtml || `<div class="empty">æš‚æ— ä¸»äººä¿¡æ¯</div>`;
        }

        // 11. æ£€æŸ¥æ˜¯å¦è§¦å‘æŒ‡å®šå¯¹è¯
        function checkChatTrigger(filteredOC, now) {
            const chatWrap = document.getElementById("chatBubbleWrap");
            // è·å–å½“å‰åœ°ç‚¹çš„å¯¹è¯
            const areaChats = chatData.filter(chat => chat.area === currentSmallArea);
            
            areaChats.forEach(chat => {
                // æ£€æŸ¥å¯¹è¯IDæ˜¯å¦å·²è§¦å‘
                if (chatTriggered.has(chat.id)) return;
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å‚ä¸äººéƒ½åœ¨åœº
                const allPresent = chat.characters.every(char => 
                    filteredOC.some(oc => oc.name === char)
                );
                
                if (allPresent) {
                    // æ ‡è®°ä¸ºå·²è§¦å‘
                    chatTriggered.add(chat.id);
                    // éšæœºé€‰ä¸€æ®µå¯¹è¯
                    const randomChat = getRandomText(chat.dialogues);
                    // æ¸²æŸ“èŠå¤©æ°”æ³¡
                    renderChatBubble(randomChat, chat.characters);
                }
            });
        }

        // 12. æ¸²æŸ“èŠå¤©æ°”æ³¡
        function renderChatBubble(dialogue, characters) {
            const chatWrap = document.getElementById("chatBubbleWrap");
            chatWrap.innerHTML = "";
            
            // æŒ‰é¡ºåºæ¸²æŸ“å¯¹è¯
            dialogue.forEach((msg, index) => {
                const charOC = ocData.find(oc => oc.name === msg.character);
                if (!charOC) return;
                
                const bubble = document.createElement("div");
                bubble.className = "chat-bubble";
                bubble.style.animationDelay = `${index * 0.3}s`;
                bubble.innerHTML = `
                    <img src="${charOC.avatar}" class="chat-avatar" alt="${msg.character}">
                    <div class="chat-content">
                        <div class="chat-name">${msg.character}</div>
                        <div class="chat-text">${msg.text}</div>
                    </div>
                `;
                chatWrap.appendChild(bubble);
                
                // æ‰€æœ‰æ°”æ³¡æ˜¾ç¤ºå®Œåï¼Œ5ç§’åå¼€å§‹æ¶ˆå¤±
                if (index === dialogue.length - 1) {
                    setTimeout(() => {
                        document.querySelectorAll(".chat-bubble").forEach((b, i) => {
                            setTimeout(() => {
                                b.classList.add("fade-out");
                                if (i === dialogue.length - 1) {
                                    setTimeout(() => chatWrap.innerHTML = "", 300);
                                }
                            }, i * 200);
                        });
                    }, 5000);
                }
            });
        }

        // åˆå§‹åŒ–
        loadAllData();
    </script>
</body>
</html>
